name: Dependency Submission
on:
  # Trigger on push to the main branch
  push:
    branches:
      - main
  # Allow manual trigger for testing
  workflow_dispatch:

permissions:
  contents: write

jobs:
  submit-dependencies:
    runs-on: ubuntu-latest

    env:
      SNAPSHOT_FILE_PATH: 'dependency-snapshot.json'
    
    # Optional: Use a matrix if you have a huge number of subdirectories
    # and want to parallelize the scan, but usually not needed for NPM.

    steps:
      - name: ‚¨áÔ∏è Checkout Repository
        uses: actions/checkout@v4
        
      - name: üõ†Ô∏è Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '12' # Use your project's required Node version
          
      - name: üì¶ Install Dependencies (Skip Install Scripts)
        # This command is critical as it resolves all dependencies, 
        # including those in sub-directories/workspaces, and updates lock files.
        run: npm install --production --no-cache
        
      - name: ‚öôÔ∏è Generate and Submit Dependency Snapshot
        # This step uses a third-party action to read the lock files, 
        # map the dependencies, and submit them to the GitHub Dependency Graph.
        # NOTE: You may need to replace this with a specific action like 
        # one that supports your monorepo tool (e.g., Lerna, Nx, etc.) 
        # or a generic NPM snapshot tool.
        uses: actions/upload-dependency-snapshot@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          output-json-file: ${{ env.SNAPSHOT_FILE_PATH }}
          # Optional: Specify the package manager if the action needs it.
          # package-manager: 'npm'
      - name: ‚¨ÜÔ∏è Upload Dependency Snapshot Artifact
        uses: actions/upload-artifact@v4
        with:
          name: dependency-snapshot
          path: ${{ env.SNAPSHOT_FILE_PATH }}
          # Optional: Only keep the artifact for 5 days
          retention-days: 5
