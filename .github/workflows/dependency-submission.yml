name: Dependency Submission
on:
  # Trigger on push to the main branch
  push:
    branches:
      - main
  # Allow manual trigger for testing
  workflow_dispatch:

permissions:
  contents: write # Required for submitting the snapshot to GitHub

jobs:
  submit-dependencies:
    runs-on: ubuntu-latest

    env:
      SNAPSHOT_FILE_PATH: 'output.json'
    
    steps:
      - name: ‚¨áÔ∏è Checkout Repository
        uses: actions/checkout@v4
        
      - name: üõ†Ô∏è Set up Node.js
        uses: actions/setup-node@v4
        with:
          # Use an actively supported LTS version for better compatibility
          node-version: '20' 
          
      - name: üì¶ Install Dependencies & Update Lock File (Secure)
        # Guarantees package-lock.json is up-to-date. --ignore-scripts maintains security.
        run: npm install --ignore-scripts --force-lock

      - name: ‚öôÔ∏è Generate Snapshot JSON
        run: |
          npm install --global @github/dependency-submission-cli
          gh dependency-submission generate --allow-any-sha \
             --package-manager npm \
             --lock-file ./package-lock.json \
             --output-file ${{ env.SNAPSHOT_FILE_PATH }}

      - name: ‚è´ Submit Dependency Snapshot
        run: gh dependency-submission create ${{ env.SNAPSHOT_FILE_PATH }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

